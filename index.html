<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MicroHOA Water Billing Allocator</title>
  <meta name="description" content="Penny-perfect water/sewer allocation for small associations" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23098' d='M12 2c3.5 4.7 7 8.38 7 12a7 7 0 1 1-14 0c0-3.62 3.5-7.3 7-12z'/%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light; }
    .card { border:1px solid #e4e4e7; border-radius:24px; background:#fff; padding:20px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .btn { display:inline-flex; align-items:center; gap:8px; border-radius:16px; padding:8px 16px; font-size:14px; font-weight:600; transition:background .2s ease, box-shadow .2s ease; cursor:pointer; }
    .btn-primary { background:#0f766e; color:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.06); }
    .btn-primary:hover { background:#115e59; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .input, .select { width:100%; border:1px solid #d4d4d8; border-radius:16px; padding:8px 12px; background:#fff; color:#18181b; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .input:focus, .select:focus { outline:none; box-shadow:0 0 0 2px #14b8a6; }
    .label { display:block; font-size:14px; font-weight:500; color:#3f3f46; }
    .help { font-size:12px; color:#71717a; }
  </style>
</head>
<body class="min-h-screen w-full bg-gradient-to-b from-teal-50 to-white text-zinc-900">
  <div class="mx-auto max-w-5xl px-4 py-10">
    <header class="mb-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-teal-600 text-white shadow">
          <svg viewBox="0 0 24 24" class="h-6 w-6" aria-hidden>
            <path fill="currentColor" d="M12 2c3.5 4.7 7 8.38 7 12a7 7 0 1 1-14 0c0-3.62 3.5-7.3 7-12z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-3xl font-semibold tracking-tight">MicroHOA Water Billing Allocator</h1>
          <p class="text-sm text-zinc-500">Penny-perfect allocations for small associations</p>
        </div>
      </div>
      <span class="hidden rounded-2xl border border-teal-200 bg-white px-3 py-2 text-sm font-medium text-teal-700 shadow-sm md:inline-flex">MicroHOA</span>
    </header>

    <div class="card mb-6">
      <div class="grid grid-cols-1 gap-5 md:grid-cols-2">
        <div>
          <label class="label">HOA</label>
          <select id="hoa" class="select">
            <option>Sherman Townhomes</option>
          </select>
          <p class="help mt-1">More HOAs can be added later.</p>
        </div>
        <div>
          <label for="chargeName" class="label">Import Charge Name</label>
          <input id="chargeName" class="input" placeholder="Water Billing" />
          <p class="help mt-1">Remembered between sessions. Used for the Import sheet.</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
        <div>
          <label for="bill" class="label">Bill PDF</label>
          <input id="bill" type="file" accept="application/pdf" class="input" />
          <p class="help mt-1">Utility bill (PDF). I’ll parse dates & category totals.</p>
        </div>
        <div>
          <label for="usage" class="label">Usage CSV</label>
          <input id="usage" type="file" accept=".csv,text/csv" class="input" />
          <p class="help mt-1">Columns needed: <em>Unit</em>, <em>Meter Usage</em> (blanks=0).</p>
        </div>
        <div>
          <label for="owner" class="label">Owner Export (Account Map)</label>
          <input id="owner" type="file" accept=".csv,text/csv" class="input" />
          <p class="help mt-1">Only <em>Unit</em> and <em>Account</em> are used. Address may be used to extract unit #.</p>
        </div>
      </div>

      <div class="mt-8 grid grid-cols-1 gap-4 md:grid-cols-4">
        <div>
          <label class="label" for="fix-billingStart">Billing Start</label>
          <input id="fix-billingStart" type="date" class="input" />
        </div>
        <div>
          <label class="label" for="fix-billingEnd">Billing End</label>
          <input id="fix-billingEnd" type="date" class="input" />
        </div>
        <div>
          <label class="label" for="fix-billDate">Bill Date</label>
          <input id="fix-billDate" type="date" class="input" />
        </div>
        <div>
          <label class="label" for="fix-dueDate">Due Date</label>
          <input id="fix-dueDate" type="date" class="input" />
        </div>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-5">
        <div>
          <label class="label" for="fix-water">Water ($)</label>
          <input id="fix-water" type="number" step="0.01" placeholder="0.00" class="input" />
        </div>
        <div>
          <label class="label" for="fix-sewer">Sewer ($)</label>
          <input id="fix-sewer" type="number" step="0.01" placeholder="0.00" class="input" />
        </div>
        <div>
          <label class="label" for="fix-stormwater">Stormwater ($)</label>
          <input id="fix-stormwater" type="number" step="0.01" placeholder="0.00" class="input" />
        </div>
        <div>
          <label class="label" for="fix-base">Base ($)</label>
          <input id="fix-base" type="number" step="0.01" placeholder="0.00" class="input" />
        </div>
        <div>
          <label class="label" for="fix-superfund">Portland Harbor Superfund ($)</label>
          <input id="fix-superfund" type="number" step="0.01" placeholder="0.00" class="input" />
        </div>
      </div>

      <div class="mt-8 flex items-center gap-3">
        <button id="process" class="btn btn-primary">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M12 3v18"/></svg>
          Process & Generate
        </button>
        <p id="msg" class="help"></p>
      </div>

      <div id="downloads" class="mt-6 grid grid-cols-1 gap-3 sm:grid-cols-3"></div>
    </div>

    <div class="mt-8 text-xs text-zinc-500">
      <p><strong>How it works:</strong> I parse the bill PDF for dates &amp; category totals; read usage &amp; owner CSVs; allocate costs (usage proportional for Water/Sewer; equal split for Stormwater/Base/Superfund) with penny-perfect reconciliation (usage cats distribute remaining cents by highest usage first; flat by unit order). Then I export a full workbook and "Import-only" files.</p>
    </div>

    <footer class="mt-12 border-t border-zinc-200 py-6 text-xs text-zinc-500">
      <div class="flex flex-col items-start justify-between gap-3 sm:flex-row sm:items-center">
        <span>© <span id="year"></span> MicroHOA — Water Billing Allocator</span>
        <span class="text-zinc-400">Built for Sherman Townhomes (more HOAs coming soon)</span>
      </div>
    </footer>
  </div>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script type="module">
    import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.5.136/build/pdf.mjs";

    //  Fix: Use a real module worker instead of workerSrc
    pdfjsLib.GlobalWorkerOptions.workerPort = new Worker(
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.5.136/build/pdf.worker.mjs",
      { type: "module" }
    );

    const $ = (id) => document.getElementById(id);
    const msg = $("msg");
    const downloads = $("downloads");
    const chargeNameInput = $("chargeName");
    chargeNameInput.value = localStorage.getItem("mh_charge_name") || "Water Billing";
    $("year").textContent = new Date().getFullYear();

    const currency = (n) => n.toLocaleString(undefined, { style: "currency", currency: "USD" });

    const parseUsDate = (s) => {
      const m1 = s.match(/\b(\d{1,2})\/(\d{1,2})\/(\d{2,4})\b/);
      if (m1) {
        const y = Number(m1[3].length === 2 ? (Number(m1[3]) + 2000) : m1[3]);
        const d = Number(m1[2]);
        const mo = Number(m1[1]) - 1;
        const dt = new Date(y, mo, d);
        return isNaN(dt.getTime()) ? undefined : dt;
      }
      const m2 = s.match(/\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Sept|Oct|Nov|Dec)[a-z]*\s+\d{1,2},\s*\d{4}\b/i);
      if (m2) return new Date(m2[0]);
      return undefined;
    };

    const toStartOfNextMonth = (d) => {
      const base = d || new Date();
      return new Date(base.getFullYear(), base.getMonth() + 1, 1);
    };
    const fileToArrayBuffer = (f) => new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsArrayBuffer(f);
    });
   const fileToText = (f) => new Promise((res, rej) => {
  const r = new FileReader();
  r.onload = () => res(r.result);
  r.onerror = rej;
  r.readAsText(f);
});

    const normalizeMoney = (s) => Number(String(s).replace(/[^\d.-]/g, "")) || 0;
    const byNumericUnitOrder = (a,b) => {
      const na = Number(String(a).replace(/\D/g, ""));
      const nb = Number(String(b).replace(/\D/g, ""));
      if (!isNaN(na) && !isNaN(nb)) return na-nb;
      return String(a).localeCompare(String(b));
    };
    const streetNumber = (addr) => {
      if (!addr) return;
      const m = String(addr).match(/\b(\d{1,6})\b/);
      return m ? m[1] : undefined;
    };

    async function parseBillPDF(file) {
      const ab = await fileToArrayBuffer(file);
      const doc = await pdfjsLib.getDocument({ data: ab }).promise;
      let text = "";
      for (let p = 1; p <= doc.numPages; p++) {
        const page = await doc.getPage(p);
        const content = await page.getTextContent();
        text += "\n" + content.items.map((it) => (it.str || "")).join("\n");
      }
      const t = text.replace(/\u00A0/g, " ");
      const findMoney = (label) => {
        const m = t.match(new RegExp(label.source + `[":\\s-]*\\$?\\s*([\\n\\r\\t\\s$,\\d.-]+)`, "i"));
        return m ? normalizeMoney(m[1]) : 0;
      };
      const water = findMoney(/\bWater\b/);
      const sewer = findMoney(/\bSewer\b/);
      const storm1 = findMoney(/Stormwater\s*(?:Total)?/);
      const billableArea = findMoney(/Billable\s*Area/);
      const serviceUnit = findMoney(/Service\s*Unit/);
      const stormwater = storm1 || (billableArea + serviceUnit);
      const base = findMoney(/Base(\s*Charge)?/);
      const superfund = findMoney(/Portland\s*Harbor\s*Superfund/);

      const dateAfter = (label) => {
        const m = t.match(new RegExp(label.source + `[\\"\\s:]*([^\\n\\r]+)`, "i"));
        return m ? parseUsDate(m[1].trim()) : undefined;
      };

      const billingStart = dateAfter(/Billing\s*Start/);
      const billingEnd = dateAfter(/Billing\s*End/);
      const billDate = dateAfter(/Bill\s*Date/);
      const dueDate = dateAfter(/Due\s*Date/);

      return { billingStart, billingEnd, billDate, dueDate, totals: { water, sewer, stormwater, base, superfund }, rawText: t };
    }

    function parseUsageCSV(text) {
      const { data, meta } = Papa.parse(text, { header: true, skipEmptyLines: true });
      const rows = data;
      const headers = (meta.fields || []).map((h) => String(h||""));
      const unitCol = headers.find((h) => /^(unit|unit_no|unit number|unit#)$/i.test(h)) || headers.find((h) => /unit/i.test(h)) || headers[0];
      const usageCol = headers.find((h) => /^(meter\s*usage|usage|consumption|ccf|gallons)$/i.test(h)) || headers.find((h) => /usage|consumption|ccf|gallon/i.test(h)) || headers[1];
      return rows.map((r) => ({ unit: String(r[unitCol] ?? "").trim(), usage: String(r[usageCol] ?? "").trim() === "" ? 0 : Number(String(r[usageCol]).replace(/[^\d.\-]/g, "")) || 0 })).filter((r) => r.unit !== "");
    }

    function parseOwnerExport(text) {
      const { data, meta } = Papa.parse(text, { header: true, skipEmptyLines: true });
      const rows = data;
      const headers = (meta.fields || []).map((h) => String(h||""));
      const unitCol = headers.find((h) => /^(unit|unit_no|unit number|unit#)$/i.test(h)) || headers.find((h) => /unit/i.test(h));
      const accountCol = headers.find((h) => /^account$/i.test(h)) || headers.find((h) => /account/i.test(h));
      const addressCol = headers.find((h) => /^address$/i.test(h)) || headers.find((h) => /address/i.test(h));
      return rows.map((r) => ({ unit: r[unitCol ?? "unit"] ? String(r[unitCol ?? "unit"]).trim() : undefined, account: r[accountCol ?? "account"] ? String(r[accountCol ?? "account"]).trim() : undefined, address: r[addressCol ?? "address"] ? String(r[addressCol ?? "address"]).trim() : undefined }));
    }

    function allocate(bill, usageRows, ownerRows) {
      const normUnit = (u) => { const n = String(u).match(/\\d+/)?.[0]; return n ? n : String(u).trim(); };
      const unitsSet = new Set(); usageRows.forEach((r) => unitsSet.add(normUnit(r.unit)));
      const unitToAccount = new Map(); ownerRows.forEach((row) => { const u = row.unit ? normUnit(row.unit) : (streetNumber(row.address) ?? undefined); if (!u) return; if (row.account) unitToAccount.set(u, row.account); });
      const units = Array.from(unitsSet).sort(byNumericUnitOrder); const usageBy
      // ... rest of allocation & workbook code same ...
    }

    // Remainder of code unchanged...
  </script>
</body>
</html>

